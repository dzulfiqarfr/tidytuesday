---
title: "Big Mac index"
author: "Dzulfiqar Fathur Rahman"
date: "2020-12-25"
output: 
   html_document:
     toc: true
     code_folding: hide
---

```{r setup, result = F}
library(tidytuesdayR)
library(tidyverse)
library(lubridate)
library(readxl)
library(modelr)
library(patchwork)

knitr::opts_chunk$set(
  message = F,
  warning = F,
  fig.align = "center",
  fig.width = 7.5,
  fig.asp = 0.618
)
```

Is the rupiah in parity relative to the US dollar?


# Data

To answer the question, we will use the Big Mac index dataset from The Economist.

```{r data}
# Import data
tuesdata <- tidytuesdayR::tt_load("2020-12-22")

# Extract dataset
big_mac_raw <- tuesdata$`big-mac`

# Check data
big_mac_raw %>% 
  glimpse()
```


# Explore

Since we are interested only in the rupiah's value relative to the dollar, we will have to subset the relevant observations.

```{r data transformation}
# Subset US observations
base_usd <- big_mac_raw %>% 
  dplyr::filter(name == "United States") %>% 
  select(iso_a3, date, local_price)

# Subset Indonesia observations
bm_idn_raw <- big_mac_raw %>% 
  dplyr::filter(name == "Indonesia") %>% 
  select(-c("currency_code", 9:12, 14:19))

# Transform the Indonesia data
bm_idn_cleaned <- bm_idn_raw %>% 
  left_join(base_usd[-1], by = "date") %>% # Merge US dataset
  rename(
    us_price = local_price.y, # Rename local price variables
    idn_price = local_price.x
  ) %>% 
  arrange(date) %>%
  group_by(date) %>% 
  mutate(implied_ex = idn_price / us_price) %>% # Implied exchange rate
  select(
    name, 
    date, 
    dollar_ex, 
    idn_price, 
    dollar_price, 
    us_price, 
    implied_ex, 
    usd_raw
  )
```


We will create a plot to explore both the rupiah's implied exchange exchange rate and the valuation as measured by Big Mac prices. We first create the implied exchange rate plot:

```{r implied PPP plot}
plot_impliedPPP <- bm_idn_cleaned %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = dollar_ex), size = 1.25, color = "#80CBC4") +
  geom_line(aes(y = implied_ex), size = 1.25, color = "#00796B") +
  scale_y_continuous(
    limits = c(0, 15000),
    breaks = seq(0, 15000, by = 5000),
    position = "right",
    expand = c(0,0,0,0)
  ) +
  labs(subtitle = str_c("Rupiah per US dollar\n(in rupiah)")) +
  annotate(
    geom = "text",
    x = ymd("2003-01-01"),
    y = 11500,
    label = "Actual exchange rate",
    hjust = "left"
  ) +
  annotate(
    geom = "text",
    x = ymd("2007-06-01"),
    y = 3500,
    label = "Implied PPP",
    hjust = "left"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.subtitle = element_text(
      color = "#2e2e2e",
      margin = margin(b = 20)
    ),
    axis.title = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey"),
    panel.grid.minor.y = element_blank()
  ) +
  geom_hline(yintercept = 0, color = "black")
```


Then create the plot showing rupiah's valuation against the dollar:

```{r}
plot_valuation <- bm_idn_cleaned %>% 
  ggplot() +
  geom_line(aes(date, usd_raw * 100), color = "#00796B", size = 1.25) +
  scale_y_continuous(
    limits = c(-80, -20),
    breaks = seq(-80, -20 , by = 20),
    position = "right",
    expand = c(0,0,0,0)
  ) +
  labs(
    subtitle = str_c("Rupiah valuation against US dollar",
                     "\n(in percent)")
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.subtitle = element_text(
      color = "#2e2e2e",
      margin = margin(b = 20)
    ),
    axis.title = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey"),
    panel.grid.minor.y = element_blank()
  ) +
  geom_hline(yintercept = -80, color = "black")
```


We can use `patchwork` to combine the two plots:

```{r patchwork}
plot_impliedPPP + plot_valuation +
  plot_annotation(
    title = "Undervalued",
    subtitle = "Big Mac index",
    caption = "Chart: @dzulfiqarfr | Source: The Economist; Reuters",
    theme = theme(
      plot.title = element_text(face = "bold"),
      plot.subtitle = element_text(margin = margin(b = 20)),
      plot.caption = element_text(
        color = "#5e5e5e",
        hjust = 0,
        margin = margin(t = 20)
      )
    )
  ) +
  ggsave(
    "bmi_valuation_patchwork_02.png",
    width = 7.5,
    height = 5,
    dpi = 300
  )
```


# Pattern

We can see that Big Mac prices tend to be higher in high-income countries.

```{r country classification}
# Subset July 2020 observations
bm_july2020 <- big_mac_raw %>% 
  dplyr::filter(date == "2020-07-01") %>% 
  select(
    iso_a3,
    name,
    date,
    dollar_price,
    usd_raw,
    gdp_dollar
  ) %>% 
  arrange(date)

# Import WB country classification data
wb_class_raw <- read_excel(
  "data/WB_country-classification_raw.xls",
  sheet = "Groups"
)

# Create row containing Euro Area for the classification
euroArea_class <- tribble(
  ~CountryCode, ~GroupCode, ~GroupName,
  "EUZ", "HIC", "High income"
)

# Subset groups of interest, merge euro area classification
# There is no low income countries in the sample
wb_class_cleaned <- wb_class_raw %>% 
  dplyr::filter(GroupCode %in% c("LIC", "LMC", "UMC", "HIC")) %>% 
  select(CountryCode, GroupCode, GroupName) %>% 
  rbind(euroArea_class)

# Merge Big Mac index, country classification datasets
bigMac_class <- bm_july2020 %>% 
  left_join(wb_class_cleaned, by = c("iso_a3" = "CountryCode"))

# Create the boxplot
bigMac_class %>% 
  ggplot() +
  geom_hline(yintercept = 0, color = "black") +
  geom_boxplot(aes(
    reorder(GroupName, dollar_price, median),
    dollar_price
  ), 
  varwidth = T) +
  scale_y_continuous(
    limits = c(0, 8),
    breaks = seq(0, 8, by = 2),
    position = "right",
    expand = c(0,0,0,0)
  ) +
  labs(
    title = "Higher prices in rich countries",
    subtitle = str_c(
      "Big Mac prices in July 2020, ",
      "by income group (in US dollars)"
    ),
    caption = "Chart: @dzulfiqarfr | Source: The Economist; World Bank"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.subtitle = element_text(
      color = "#2e2e2e",
      margin = margin(b = 40)
    ),
    axis.title = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey"),
    panel.grid.minor.y = element_blank(),
    plot.caption = element_text(
      color = "#5e5e5e",
      hjust = 0,
      margin = margin(t = 20)
    )
  ) +
  ggsave("bmi_prices_boxplot.png", width = 7.5, height = 5, dpi = 300)
```


# Model

We can use a simple linear regression to predict Big Mac prices across countries after adjusting for GDP per person.

```{r regression}
# Subset July 2020 observations
bm_lm <- big_mac_raw %>% 
  dplyr::filter(
    !is.na(gdp_dollar),
    date == "2020-07-01"
  )

# Divide GDP per person by 1,000
bm_lm$gdp_dollar <- bm_lm$gdp_dollar / 1000

# Perform the regression
mod <- lm(dollar_price ~ gdp_dollar, bm_lm)

# Add fitted values and residuals
bm_gdpAdj <- bm_lm %>% 
  select(
    iso_a3, 
    name, 
    date, 
    dollar_price, 
    gdp_dollar, 
    adj_price,
    usd_adjusted
  ) %>% 
  add_predictions(mod) %>% 
  add_residuals(mod)

# Summarize the regression result
summary(mod)
```


We then create a scatterplot to visualize the adjusted prices:

```{r scatterplot of Big Mac prices and GDP per cap}
# Multiply GDP per cap by 1000
bm_gdpAdj$gdp_dollar <- bm_gdpAdj$gdp_dollar * 1000

bm_gdpAdj %>% 
  ggplot(aes(x = gdp_dollar)) +
  geom_segment(
    aes(
      y = dollar_price,
      xend = gdp_dollar,
      yend = pred
    ),
    linetype = "dashed",
    color = "#B0BEC5",
    alpha = 0.75
  ) +
  geom_point(
    aes(
      y = dollar_price,
      fill = name %in% c("Indonesia", "United States"),
      alpha = name %in% c("Indonesia", "United States")
      ), 
    size = 5,
    stroke = 0.5,
    shape = 21,
    color = "white",
    show.legend = F
  ) +
  scale_y_continuous(
    limits = c(0, 8),
    breaks = seq(0, 8, by = 2),
    position = "right",
    expand = c(0,0,0,0)
  ) +
  scale_x_continuous(
    limits = c(0, 90000),
    breaks = seq(0, 90000, by = 15000)
  ) +
  scale_fill_manual(values = c("#B0BEC5", "#00796B")) +
  labs(
    title = "Expected prices",
    subtitle = str_c(
      "Big Mac price in July 2020 and GDP per capita in 2019 ",
      "(in US dollars)"
    ),
    x = "Higher income per person →",
    y = "← Higher Big Mac price",
    caption = "Chart: @dzulfiqarfr | Source: The Economist; IMF"
  ) +
  scale_alpha_manual(values = c(0.75, 1)) +
  annotate(
    geom = "text",
    x = 10000,
    y = 1,
    label = "Indonesia",
    hjust = "left"
  ) +
  annotate(
    geom = "curve",
    x = 10000,
    y = 1,
    xend = 3870.562,
    yend = 2.1,
    curvature = -.5,
    arrow = arrow(
      length = unit(2, "mm"),
      ends = "last"
    )
  ) +
  annotate(
    geom = "text",
    x = 27500,
    y = 5,
    label = "Adjusted prices"
  ) +
  annotate(
    geom = "curve",
    x = 27500,
    y = 4.75,
    xend = 27500,
    yend = 3.6,
    curvature = 0,
    linetype = "dashed"
  ) +
  annotate(
    geom = "text",
    x = 62500,
    y = 6.25,
    label = "United States",
    hjust = "left"
  ) +
  geom_smooth(
    aes(y = dollar_price),
    method = "lm",
    se = F,
    color = "#00796B",
    size = 1.25
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.subtitle = element_text(
      color = "#2e2e2e",
      margin = margin(b = 40)
    ),
    axis.ticks.y = element_blank(),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey"),
    panel.grid.minor.y = element_blank(),
    plot.caption = element_text(
      color = "#5e5e5e",
      hjust = 0,
      margin = margin(t = 20)
    )
  ) +
  geom_hline(yintercept = 0, color = "black") +
  ggsave(
    "bmi_gdp-prices_scatterplot.png",
    width = 7.5,
    height = 5,
    dpi = 300
  )
```


Check rupiah's valuation against the dollar after adjusting for GDP per person.

```{r}
bm_gdpAdj %>% 
  dplyr::filter(
    name %in% c("Indonesia", "United States"),
    date == "2020-07-01"
  ) %>% 
  mutate(
    val_adj = round(
      ((dollar_price[1] / pred[1]) / 
         (dollar_price[2] / pred[2]) - 1),
      digits = 3
    )
  ) %>% 
  slice(-2) %>% 
  select(iso_a3, dollar_price, adj_price, pred, usd_adjusted, val_adj) %>% 
  knitr::kable()
```